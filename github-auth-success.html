<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GitHub Authorization Success</title>
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.css">
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="./config.js"></script>
  <style>
    .content {
      padding: 1rem;
      text-align: center;
    }
    .success-icon {
      font-size: 48px;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="content">
    <div class="success-icon">⚪</div>
    <h2>GitHub Authorization</h2>
    <p id="status">Processing authorization...</p>
  </div>

  <script>
    var t = TrelloPowerUp.iframe({
      appKey: POWERUP_API_KEY,
      appName: 'CodeAIgent'
    });

    // Get code and state from URL
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');

    // Helper function to encode token
    function encodeToken(token) {
      return btoa(token);
    }

    // Function to notify the Power-Up that GitHub is connected
    function notifyPowerUp(success) {
      // Try to find any opener window that might be the Trello tab
      if (window.opener) {
        try {
          window.opener.postMessage(
            { 
              type: 'github-auth-callback',
              success: success
            }, 
            '*'
          );
        } catch (e) {
          console.error('Failed to notify opener:', e);
        }
      }
    }

    // Validate state and exchange code for token
    t.get('member', 'private', 'githubOAuthState')
      .then(function(savedState) {
        if (state !== savedState) {
          throw new Error('Invalid state parameter');
        }
        
        // Exchange code for token using backend
        return fetch(`${BACKEND_URL}/validate/github/token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${encodeToken(code)}`,
            'x-power-up-token': POWERUP_API_KEY
          },
          body: JSON.stringify({
            member: {
              id: t.getContext().member
            },
            board: {
              id: t.getContext().board
            }
          })
        });
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        // Store the GitHub token
        return t.set('member', 'private', 'githubToken', data.access_token)
          .then(() => {
            document.getElementById('status').textContent = 'GitHub account connected successfully!';
            document.querySelector('.success-icon').textContent = '✅';
            notifyPowerUp(true);
            // Close the window after a short delay
            setTimeout(() => {
              window.close();
            }, 1500);
          });
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('status').textContent = 'Failed to connect GitHub account. Please try again.';
        document.querySelector('.success-icon').textContent = '❌';
        notifyPowerUp(false);
      });
  </script>
</body>
</html> 