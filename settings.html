<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>CodeAIgent Settings</title>
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.css">
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="./config.js"></script>
  <style>
    .content {
      padding: 1rem;
    }
    .section {
      margin-bottom: 1.5rem;
    }
    .section-title {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .status {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .status-icon {
      margin-right: 0.5rem;
    }
    .button-container {
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="content">
    <div class="section">
      <div class="section-title">ü§ñ CodeAIgent Status</div>
      <div id="trello-status" class="status">
        <span class="status-icon">‚ö™</span>
        <span>Checking Trello authorization...</span>
      </div>
    </div>

    <div class="section">
      <div class="section-title">üîó GitHub Integration</div>
      <div id="github-status" class="status">
        <span class="status-icon">‚ö™</span>
        <span>Checking GitHub connection...</span>
      </div>
      <div class="button-container">
        <button id="github-connect-btn" class="mod-primary" style="display: none;">Connect GitHub</button>
        <button id="github-settings-btn" class="mod-primary" style="display: none;">Repository Settings</button>
      </div>
    </div>
  </div>

  <script>
    var t = TrelloPowerUp.iframe();
    const trelloStatusEl = document.getElementById('trello-status');
    const githubStatusEl = document.getElementById('github-status');
    const githubConnectBtn = document.getElementById('github-connect-btn');
    const githubSettingsBtn = document.getElementById('github-settings-btn');

    // Check authorization status
    function checkAuthStatus() {
      Promise.all([
        t.get('member', 'private', 'authToken'),
        t.get('member', 'private', 'githubToken')
      ]).then(([trelloToken, githubToken]) => {
        // Update Trello status
        if (trelloToken) {
          trelloStatusEl.innerHTML = '<span class="status-icon">‚úÖ</span><span>Connected to Trello</span>';
        } else {
          trelloStatusEl.innerHTML = '<span class="status-icon">‚ùå</span><span>Not connected to Trello</span>';
        }

        // Update GitHub status
        if (githubToken) {
          githubStatusEl.innerHTML = '<span class="status-icon">‚úÖ</span><span>Connected to GitHub</span>';
          githubSettingsBtn.style.display = 'block';
          githubConnectBtn.style.display = 'none';
        } else {
          githubStatusEl.innerHTML = '<span class="status-icon">‚ùå</span><span>Not connected to GitHub</span>';
          githubConnectBtn.style.display = 'block';
          githubSettingsBtn.style.display = 'none';
        }
      });
    }

    // Listen for GitHub auth callback
    window.addEventListener('message', function(event) {
      if (event.data && event.data.type === 'github-auth-callback') {
        if (event.data.success) {
          checkAuthStatus();
          t.alert({
            message: 'GitHub account connected successfully!',
            duration: 5,
            display: 'success'
          });
        } else {
          t.alert({
            message: 'Failed to connect GitHub account. Please try again.',
            duration: 5,
            display: 'error'
          });
        }
      }
    });

    // GitHub connect button
    githubConnectBtn.addEventListener('click', () => {
      t.popup({
        title: 'GitHub Authorization',
        url: './authorize-github.html',
        height: 140,
      });
    });

    // Repository settings button
    githubSettingsBtn.addEventListener('click', () => {
      t.popup({
        title: 'Repository Settings',
        url: './repository-settings.html',
        height: 400,
      });
    });

    // Initial check
    checkAuthStatus();
  </script>
</body>
</html> 