<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>CodeAIgent Settings</title>
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.css">
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="./config.js"></script>
  <style>
    .content {
      padding: 1rem;
    }
    .section {
      margin-bottom: 1.5rem;
    }
    .section-title {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .status {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .status-icon {
      margin-right: 0.5rem;
    }
    .button-container {
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="content">
    <div class="section">
      <div class="section-title">ü§ñ CodeAIgent Status</div>
      <div id="trello-status" class="status">
        <span class="status-icon">‚ö™</span>
        <span>Checking Trello authorization...</span>
      </div>
    </div>

    <div class="section">
      <div class="section-title">üîó GitHub Integration</div>
      <div id="github-status" class="status">
        <span class="status-icon">‚ö™</span>
        <span>Checking GitHub connection...</span>
      </div>
      <div class="button-container">
        <button id="github-connect-btn" class="mod-primary" style="display: none;">Connect GitHub</button>
        <button id="github-settings-btn" class="mod-primary" style="display: none;">Repository Settings</button>
      </div>
    </div>
  </div>

  <script>
    var t = TrelloPowerUp.iframe();
    const trelloStatusEl = document.getElementById('trello-status');
    const githubStatusEl = document.getElementById('github-status');
    const githubConnectBtn = document.getElementById('github-connect-btn');
    const githubSettingsBtn = document.getElementById('github-settings-btn');

    // Check authorization status
    function checkAuthStatus() {
      Promise.all([
        t.get('member', 'private', 'authToken'),
        t.get('member', 'private', 'githubToken')
      ]).then(([trelloToken, githubToken]) => {
        // Update Trello status
        if (trelloToken) {
          trelloStatusEl.innerHTML = '<span class="status-icon">‚úÖ</span><span>Connected to Trello</span>';
        } else {
          trelloStatusEl.innerHTML = '<span class="status-icon">‚ùå</span><span>Not connected to Trello</span>';
        }

        // Update GitHub status
        if (githubToken) {
          githubStatusEl.innerHTML = '<span class="status-icon">‚úÖ</span><span>Connected to GitHub</span>';
          githubSettingsBtn.style.display = 'block';
          githubConnectBtn.style.display = 'none';
        } else {
          githubStatusEl.innerHTML = '<span class="status-icon">‚ùå</span><span>Not connected to GitHub</span>';
          githubConnectBtn.style.display = 'block';
          githubSettingsBtn.style.display = 'none';
        }
      });
    }

    // Listen for GitHub auth callback
    window.addEventListener('message', function(event) {
      if (event.data && event.data.type === 'github-auth-callback') {
        if (event.data.success) {
          checkAuthStatus();
          t.alert({
            message: 'GitHub account connected successfully!',
            duration: 5,
            display: 'success'
          });
        } else {
          t.alert({
            message: 'Failed to connect GitHub account. Please try again.',
            duration: 5,
            display: 'error'
          });
        }
      }
    });

    // GitHub connect button
    githubConnectBtn.addEventListener('click', async () => {
      // Get member info first
      const member = await t.member('id');
      const board = await t.board('id');

      // Generate state
      const state = Math.random().toString(36).substring(7);
      await t.set('member', 'private', 'githubOAuthState', state);

      // GitHub OAuth parameters
      const githubAuthUrl = 'https://github.com/login/oauth/authorize';
      const clientId = 'Iv23liFtRuiAll1ckg4i';
      const scope = 'repo read:user';
      const redirectUri = `${window.location.origin}/github-auth-success.html`;

      // Open GitHub auth in a new window
      const width = 580;
      const height = 600;
      const left = (window.screen.width / 2) - (width / 2);
      const top = (window.screen.height / 2) - (height / 2);

      window.authorize = async function(code, returnedState) {
        if (state !== returnedState) {
          t.alert({
            message: 'Invalid state parameter. Please try again.',
            duration: 5,
            display: 'error'
          });
          return;
        }

        try {
          // Exchange code for token using backend
          const response = await fetch(`${BACKEND_URL}/validate/github/token`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${btoa(code)}`,
              'x-power-up-token': POWERUP_API_KEY
            },
            body: JSON.stringify({
              member: {
                id: member.id
              },
              board: {
                id: board.id
              }
            })
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
          }

          const data = await response.json();
          
          // Store the GitHub token
          await t.set('member', 'private', 'githubToken', data.access_token);
          
          // Update UI
          checkAuthStatus();
          
          t.alert({
            message: 'GitHub account connected successfully!',
            duration: 5,
            display: 'success'
          });
        } catch (error) {
          console.error('GitHub auth error:', error);
          t.alert({
            message: 'Failed to connect GitHub account: ' + error.message,
            duration: 5,
            display: 'error'
          });
        }
      };

      window.open(
        `${githubAuthUrl}?client_id=${clientId}&scope=${scope}&redirect_uri=${redirectUri}&state=${state}`,
        'GitHubAuth',
        `width=${width},height=${height},left=${left},top=${top}`
      );
    });

    // Repository settings button
    githubSettingsBtn.addEventListener('click', () => {
      t.popup({
        title: 'Repository Settings',
        url: './repository-settings.html',
        height: 400,
      });
    });

    // Initial check
    checkAuthStatus();
  </script>
</body>
</html> 